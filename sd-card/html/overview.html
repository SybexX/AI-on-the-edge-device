<!DOCTYPE html>
<html lang="en" xml:lang="en"> 
<head>
<title>Overview</title>
<meta charset="UTF-8" />

<style>
.tg  {
	border-collapse:collapse;
	border-spacing:0;
	width:100%;
	min-width:600px;
	height:100%;
	color:darkslategray;
	}
	
.tg th{
	min-width:325px;
	width:325px;
	height:20px;
	font-size:18px;
	text-align:left;
	font-weight:bold;
	padding:5px 10px 5px 10px;
	overflow:hidden;
	word-break:normal;
	background-color:lightgrey;
	}

.tg td{
	font-size:15px;
	padding:5px 10px 5px 10px;
	overflow:hidden;
	word-break:normal;
	}

.tg .tg-1{
	font-size:15px;
	vertical-align: top;
	font-family:Arial, Helvetica, sans-serif !important;
	}

.tg .tg-2{
	height:52px;
	font-size:15px;
	padding:3px 0px 3px 10px;
	vertical-align:middle;
	font-family:Arial, Helvetica, sans-serif !important;
	}

.tg .tg-3{
	height:45px;
	font-size:15px;
	padding:3px 10px 3px 10px;
	vertical-align:middle;
	font-family:Arial, Helvetica, sans-serif !important;
	}

.tg .tg-4{
	height:fit-content;
	font-size:15px;
	padding:5px 10px 5px 10px;
	vertical-align:text-top;
	font-family:Arial, Helvetica, sans-serif !important;
	}
</style>

</head>

<body style="font-family: arial">

	<table class="tg">
		<tr>
			<th class="th">Value</th>
			<td class="tg-1" rowspan="13">
				<img style="padding-left: 5px; padding-top: 0px; max-width:100%; width:100%; height:auto;" id="img" src="">
			</td>
		</tr>	 
		<tr>	
			<td class="tg-2">
				<div id="value"></div>
			</td>	
		</tr>
		<tr>
			<th class="th">Previous Value</th>
		</tr>	
		<tr>	
			<td class="tg-2">
				<div id="prevalue"></div>
			</td>	
		</tr>
		<tr>
			<th class="th">Raw Value</th>
		</tr>	
		<tr>	
			<td class="tg-2">
				<div id="raw"></div>
			</td>	
		</tr>
		<tr>
			<th class="th">Value Status</th>
		</tr>	
		<tr>	
			<td class="tg-2">
				<div id="error"></div>
			</td>	
		</tr>
		<tr>
			<th class="th">Process State</th>
		</tr>	
		<tr>	
			<td class="tg-3">
				<div id="statusflow" ></div>
			</td>
		</tr>  
		<tr>
			<th class="th">System Info</th>
		</tr>	
		<tr>	
			<td class="tg-4">
				<div id="sntp_date" ></div>
				<div id="timestamp" ></div>	
				<div id="cputemp" ></div>	
				<div id="rssi" ></div>
				<div>
					<span id="uptime" ></span>
					<span id="round" ></span>
				</div>
			</td>
		</tr>
	</table>

	<script type="text/javascript" src="jquery-3.6.0.min.js?v=$COMMIT_HASH"></script>
	<script type="text/javascript" src="common.js?v=$COMMIT_HASH"></script> 
	<script type="text/javascript" src="readconfigcommon.js?v=$COMMIT_HASH"></script>
	<script type="text/javascript" src="readconfigparam.js?v=$COMMIT_HASH"></script>
	
	<script type="text/javascript">
		var gateway = `ws://${window.location.hostname}/ws`;
        var ws;
		domainname = getDomainname();
        window.addEventListener('load', onLoad);
        window.addEventListener('beforeunload', onUnload);
		
        function onUnload(event) {		
            ws.close();
        }		
		
        function onLoad(event) {
            initWebSocket();
        }		
		
        function initWebSocket() {
            if(ws == null) {
                console.log('Trying to open a WebSocket connection...');
			
                ws = new WebSocket(gateway);
                ws.onopen = onOpen;
                ws.onclose = onClose;
                ws.onmessage = onMessage;
                ws.error = onError;
            }
            else {
			    ws.close();
            }
        }		
		
        function onOpen(event) {
            console.log('Connection opened');
			
			ws.send('BoardType');
			ws.send('FlowStatus');
			ws.send('Round');
			ws.send('CpuTemp');
			ws.send('Date');
			ws.send('Uptime');
			ws.send('RSSI');
			
			// ws.send('Value');
			// ws.send('PreValue');
			// ws.send('RawValue');
			// ws.send('ValueStatus');
        }

        function onClose(event) {
            console.log('Connection closed');
            ws.onopen = null;
            ws.onclose = null;
            ws.onmessage = null;
            ws = null;
            setTimeout(initWebSocket, 10000);
        }

        function onMessage(event) {
            // console.log(event.data);
			
			var myObj = JSON.parse(event.data);
			var myKey = Object.keys(myObj);
			var myValue = Object.values(myObj);
			
			if(myKey == 'BoardType') {
			    console.log('BoardType: ' + myValue);
			}
			else if(myKey == 'FlowStatus') {
			    $('#statusflow').html(myValue);
			}
			else if(myKey == 'Round') {
			    $('#round').html("(Round: " + myValue + ")");
			}
			else if(myKey == 'CpuTemp') {
			    $('#cputemp').html("CPU Temperature: " + myValue + "Â°C");
			}
			else if(myKey == 'Date') {
			    $('#sntp_date').html("Date/Time on device: " + myValue);
			}
			else if(myKey == 'Uptime') {
			    $('#uptime').html("Uptime: " + myValue);
			}
			else if(myKey == 'RSSI') {
				if (myValue >= -55) {
					$('#rssi').html("WIFI Signal: Excellent (" + myValue + "dBm)");
				}
				else if (myValue < -55 && myValue >= -67) {
					$('#rssi').html("WIFI Signal: Good (" + myValue + "dBm)");
				}
				else if (myValue < -67 && myValue >= -78) {
					$('#rssi').html("WIFI Signal: Fair (" + myValue + "dBm)");
				}
				else if (myValue < -78 && myValue >= -85) {
					$('#rssi').html("WIFI Signal: Weak (" + myValue + "dBm)");
				}
				else {
					$('#rssi').html("WIFI Signal: Unreliable (" + myValue + "dBm)");
				}
			}
			else if(myKey == 'Value') {
				console.log('Value: ' + myValue);
			}
			else if(myKey == 'PreValue') {
				console.log('PreValue: ' + myValue);
			}
			else if(myKey == 'RawValue') {
				console.log('RawValue: ' + myValue);
			}
			else if(myKey == 'ValueStatus') {
				console.log('ValueStatus: ' + myValue);
			}
			else {
				console.log('WebSocket, unknown parameter: ' + myKey + ' = ' + myValue);
			}
        }
		
        function onError(event) {
            console.log('Error occurred');
			initWebSocket();
        }

		function addZero(i) {
			if (i < 10) {
				i = "0" + i;
			}
			return i;
		}

		$(document).ready(function() {
			LoadData();
			LoadROIImage();
		});

		function LoadData(){
			loadValue("value", "value", "border-collapse: collapse; width: 100%");
			loadValue("raw", "raw", "border-collapse: collapse; width: 100%");
			loadValue("prevalue", "prevalue", "border-collapse: collapse; width: 100%");
			loadValue("error", "error", "border-collapse: collapse; width: 100%");
		}

		function LoadROIImage(){
			var d = new Date();
			var timestamp = d.getTime();
			var h = addZero(d.getHours());
			var m = addZero(d.getMinutes());
			var s = addZero(d.getSeconds());
			document.getElementById("img").src = domainname + '/img_tmp/alg_roi.jpg?timestamp=' + timestamp;
			$('#timestamp').html("Last Page Refresh:" + (h + ":" + m + ":" + s));
		}

		function Refresh() {
			setTimeout (function() {
				LoadData();
				LoadROIImage();
				Refresh();
			}, 300000);
		}

		function loadValue(_type, _div, _style) {
			url = domainname + '/value?type=' + _type;     
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					var _rsp = xhttp.responseText;
					var _split = _rsp.split("\r");
					
					if (typeof _style == undefined) {
						out = "<table>";
					}
					else {
						out = "<table style=\"" + _style + "\">";
					}

					if (_split.length == 1) {
						var _zer = ZerlegeZeile(_split[0], "\t")
					
						if (_zer.length > 1) {
							out = _zer[1];
						}
						else {
							out = "";
						}
					}
					else {
						for (var j = 0; j < _split.length; ++j) {
							var _zer = ZerlegeZeile(_split[j], "\t")
						
							if (_zer.length == 1) {
								out = out + "<tr><td style=\"width: 22%; padding: 3px 5px; text-align: left; vertical-align:middle; border: 1px solid lightgrey\">" + 
								_zer[0] + "</td><td style=\"padding: 3px 5px; text-align: left; vertical-align:middle; border: 1px solid lightgrey\"> </td></tr>"; 
							}
							else {
								out = out + "<tr><td style=\"width: 22%; padding: 3px 5px; text-align: left; vertical-align:middle; border: 1px solid lightgrey\">" + 
								_zer[0] + "</td><td style=\"padding: 3px 5px; text-align: left; vertical-align:middle; border: 1px solid lightgrey\" >" + _zer[1] + "</td></tr>";
							}
						}
						out = out + "</table>"
					}
				document.getElementById(_div).innerHTML = out;
				}
			};
			
			xhttp.open("GET", url, true);
			xhttp.send();		
		}

		function init(){
			Refresh();
		}

		init();

	</script>
</body>
</html>