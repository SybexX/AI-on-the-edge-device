<!DOCTYPE html>
<html lang="en" xml:lang="en"> 

<head>
<meta charset="UTF-8"/>
<title>WifiConfiguration</title>

<link rel="stylesheet" href="mkdocs_theme.css?v=$COMMIT_HASH" />
<link rel="stylesheet" href="mkdocs_theme_extra.css?v=$COMMIT_HASH" />
<link rel="stylesheet" href="github.min.css?v=$COMMIT_HASH" />

<link rel="stylesheet" href="firework.css?v=$COMMIT_HASH" />
<link rel="stylesheet" href="ipInput.min.css?v=$COMMIT_HASH" />

<script type="text/javascript" src="common.js?v=$COMMIT_HASH"></script>
<script type="text/javascript" src="jquery-3.6.0.min.js?v=$COMMIT_HASH"></script>
<script type="text/javascript" src="firework.js?v=$COMMIT_HASH"></script>
	
<script type="text/javascript" src="ipInput.min.js?v=$COMMIT_HASH"></script>

<script type="text/javascript" src="readconfigparam.js?v=$COMMIT_HASH"></script> 
<script type="text/javascript" src="readconfigcommon.js?v=$COMMIT_HASH"></script>  
<script language="JavaScript">var domainname = getDomainname();</script> 

<style>
    h1 {font-size: 2em;}
    h2 {font-size: 1.5em; margin-block-start: 0.0em; margin-block-end: 0.2em;}
    h3 {font-size: 1.2em;}
    h4 {font-size: 1.05em; margin-bottom: 0;}
    h5 {font-size: 0.83em; margin-top: 0.2em; margin-bottom: 0;}
    p {font-size: 1em;}

    .table {
        border: 0pt;
        border-collapse: collapse;
        table-layout: fixed;
        width:100%;
    }

    td {
        padding: 10px;
        vertical-align: middle;
    }

    .button {
        padding: 5px 10px;
        width: 220px;
        font-size: 16px;	
    }

    input[type=number] {
        width: 60px;
        min-width: 60px;
        max-width: 60px;
        margin-right: 10px;
        padding: 3px 5px;
        display: inline-block;
        border: 1px solid #ccc;
        font-size: 16px;
        vertical-align: middle;
    }

    input[type=text] {
        width:82%;
        max-width:96%;
        margin-right: 10px;
        padding: 3px 5px;
        display: inline-block;
        border: 1px solid #ccc;
        font-size: 16px;
        vertical-align: middle;
    }

    input[type=password] {
        width:82%;
        max-width:96%;
        margin-right: 10px;
        padding: 3px 5px;
        display: inline-block;
        border: 1px solid #ccc;
        font-size: 16px;
        vertical-align: middle;
    }

    select {
        min-width: 72px;
        max-width: 100%;
        padding: 3px 5px;
        display: inline-block;
        border: 1px solid #ccc;
        font-size: 16px; 
        margin-right: 10px;
        vertical-align: middle;
    }

    .select_large {
        width: 100%;
        min-width: 200px;
        max-width: 100%;
        padding: 3px 5px;
        display: inline-block;
        border: 1px solid #ccc;
        font-size: 16px; 
        margin-right: 10px;
        vertical-align: middle;
    }

    textarea {
        font-size: 14px;
    }

    .description {
        color: black;
        font-size: 80%;
    }

    .disabled {
        color:rgb(122, 122, 122);
    }

    .invalid-input {
        background-color: #FFAA00;
    }

    input:out-of-range {
        background-color: rgba(255, 0, 0, 0.25);
        border: 1px solid red;
    }

    input:invalid {
        background-color: rgba(255, 0, 0, 0.25);
        border: 1px solid red;
    }

    .hidden {
        display: none;
    }

    .indent1 {
        padding-left: 25px;
        font-size: 16px;
    }

    .indent2 {
        padding-left: 50px;
        font-size: 16px;
    }

    .tooltip {
        position: relative;
        display: inline-block;
    }

    .tooltip .tooltiptext {
        visibility: hidden;
        width: 500px;
        background-color: #fcfcfc;

        padding: 5px;
        padding-bottom: 0;

        border: solid black 2px; 

        /* Position the tooltip */
        position: absolute;
        z-index: 1;
        top: 100%;
        left: 100%;
        margin-left: -500px;
    }

    .tooltip:hover .tooltiptext {
        visibility: visible;
    }

    .tooltip-content {
        width: calc(100% - 2px);
        height: calc(100% - 2px);
        padding: 1px;
    }
	
    #overlay {
        position: fixed;
        display: none;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.8);
        z-index: 2;
    }

    #overlaytext{
        position: absolute;
        top: 50%;
        left: 50%;
        font-size: 150%;
        color: white;
        transform: translate(-50%,-50%);
        -ms-transform: translate(-50%,-50%);
    }

    .c, body {
        font-family: verdana
    }

    .h {
        display: none;
    }

    .q {
        height: 16px;
        margin: 0;
        padding: 0 5px;
        text-align: right;
        min-width: 38px;
        float:right;
    }

    .q.q-0:after {
        background-position-x: 0;
    }

    .q.q-1:after {
        background-position-x: -16px;
    }

    .q.q-2:after {
        background-position-x: -32px;
    }

    .q.q-3:after {
        background-position-x: -48px;
    }

    .q.q-4:after {
        background-position-x: -64px;
    }

    .q.l:before {
        background-position-x: -80px;
        padding-right: 5px
    }

    .ql .q {
        float: left;
    }

    .q:after, .q:before {
        content: '';width:16px;height:16px;display:inline-block;background-repeat:no-repeat;background-position: 16px 0;
        background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAAAQCAMAAADeZIrLAAAAJFBMVEX///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADHJj5lAAAAC3RSTlMAIjN3iJmqu8zd7vF8pzcAAABsSURBVHja7Y1BCsAwCASNSVo3/v+/BUEiXnIoXkoX5jAQMxTHzK9cVSnvDxwD8bFx8PhZ9q8FmghXBhqA1faxk92PsxvRc2CCCFdhQCbRkLoAQ3q/wWUBqG35ZxtVzW4Ed6LngPyBU2CobdIDQ5oPWI5nCUwAAAAASUVORK5CYII=');
    }	
	
</style>

</head>
	
<body style="font-family: arial; padding: 0px 10px;">
    <div id="overlay">
        <div id="overlaytext"></div>
    </div>

    <h2>Network Configuration</h2>

    <hr>
	
    <div id="ssid">
    </div>

    <table class="table">
        <colgroup>
            <col span="1" style="width:180px">
            <col span="1" style="width:360px">
            <col span="1">
        </colgroup>

        <tr id="ConnectionType">
            <td>Connection Type</td>
            <td>
                <select name="myConnectionType" id="myConnectionType" onchange="networkParameterChanged()">
                    <!---<option value="Wifi_AP_Setup">Wifi AP Setup</option>--->
                    <option value="Wifi_AP">Wifi AP</option>
                    <option value="Wifi_STA" selected>Wifi STA</option>
                    <!---<option value="Ethernet">Ethernet</option>--->
                    <!---<option value="Disconnect">Disconnect</option>--->
                </select>
            </td>
            <td class="tooltip" style="display:none;"></td>
        </tr>

        <tr id="Wifi_Hostname">
            <td>Hostname</td>
            <td>
                <input type="text" name="myHostname" id="myHostname" onchange="networkParameterChanged()">
            </td>
            <td>
                <div class="rst-content">
                    <div class="tooltip">
                        <img src="help.png" width="32px">
                        <span class="tooltiptext">
                            <h3 style="margin: 0">Parameter <code>Device Hostname</code></h3>
                            <p>Default Value: <code>watermeter</code></p>
                            <p>Hostname for the device. It gets automatically transferred to <code>/network.ini</code> on the SD-Card at the next startup.</p>
                        </span>
                    </div>
                </div>
            </td>
        </tr>

        <tr id="Wifi_ssid">
            <td>SSID</td>
            <td>
                <input type="text" name="mySSID" id="mySSID" onchange="networkParameterChanged()">
            </td>
            <td>
                <div class="rst-content">
                    <div class="tooltip">
                        <img src="help.png" width="32px">
                        <span class="tooltiptext">
                            <h3 style="margin: 0">Parameter <code>Wifi SSID</code></h3>
                            <p>SSID of the WLAN.</p>
                        </span>
                    </div>
                </div>
            </td>
        </tr>
		
        <tr id="Wifi_password">
            <td>Password</td>
            <td>
                <input type="password" name="myPassword" id="myPassword" onchange="networkParameterChanged()">
            </td>
            <td>
                <div class="rst-content">
                    <div class="tooltip">
                        <img src="help.png" width="32px">
                        <span class="tooltiptext">
                            <h3 style="margin: 0">Parameter <code>Wifi Password</code></h3>
                            <p>Password of the WLAN.</p>
                            <div class="admonition warning">
                                <p class="admonition-title">Warning</p>
                                <p>The password will not be encrypted during the sending!</p>
                            </div>
                        </span>
                    </div>
                </div>
            </td>
        </tr>

        <tr id="Wifi_rssi">
            <td>RSSI Threshold</td>
            <td>
                <input type="number" name="myThreshold" id="myThreshold" min="-100"  max="0" step="1" value = "0" onchange="networkParameterChanged()">
            </td>
            <td>
                <div class="rst-content">
                    <div class="tooltip">
                        <img src="help.png" width="32px">
                        <span class="tooltiptext">
                            <h3 style="margin: 0">Parameter <code>Wifi RSSIThreshold</code></h3>
                            <p>Default Value: <code>0</code></p>
                            <p>Possible values: <code>-100</code> .. <code>0</code> (<code>0</code> = disabled).</p>
                            <div class="admonition warning">
                                <p class="admonition-title">Warning</p>
                                <p>This is an <strong>Expert Parameter</strong>! Only change it if you understand what it does!</p>
                            </div>
                            <p>This parameter activates a client triggered AP switching functionality (simplified roaming). 
                                If actual RSSI value is lower (more negative) than <code>RSSIThreshold</code>, 
                                all WIFI channels will be scanned for configured access point SSID. 
                                If an access point is in range which has better RSSI value (less negative) than actual RSSI value + 5 dBm, 
                                the device is trying to connect to this access point with the better RSSI value.</p>
                            <div class="admonition note">
                                <p class="admonition-title">Note</p>
                                <p>The RSSI check only gets initiated at the end of each round to avoid any disturbance of processing.</p>
                            </div>
                            <div class="admonition note">
                                <p class="admonition-title">Note</p>
                                <p>It gets automatically transferred to <code>/network.ini</code> on the SD-Card at next startup.</p>
                            </div>
                        </span>
                    </div>
                </div>
            </td>
        </tr>

        <!------------- FixedIP ------------------>
        <tr>
            <td>Fixed IP</td>
            <td>
                <select name="myFixedIP" id="myFixedIP" onclick = "UpdateAfterFixedIPCheck()">
                    <option value="false" selected>Disable</option>
                    <option value="true">Enable</option>
                </select>
            </td>
            <td class="tooltip" style="display:none;"></td>
        </tr>

        <tr class="FixedIP hidden">
            <td class="indent1">IP</td>
            <td>
                <div id="esp32_ip" onchange="networkParameterChanged()"> </div>
            </td>
            <td>
                <div class="rst-content">
                    <div class="tooltip">
                        <img src="help.png" width="32px">
                        <span class="tooltiptext">
                            <h3 style="margin: 0">Parameter <code>Device IP</code></h3>
                            <p> </p>
                            <div class="admonition note">
                                <p class="admonition-title">Note</p>
                                <p>Leave emtpy if set by router.</p>
                            </div>
                            <p>Permanently assigned IP for this device.</p>
                        </span>
                     </div>
                </div>
            </td>
        </tr>
		
        <tr class="FixedIP hidden">
            <td class="indent1">Gateway</td>
            <td>
                <div id="esp32_gateway" onchange="networkParameterChanged()"> </div>
            </td>
            <td>
                <div class="rst-content">
                    <div class="tooltip">
                        <img src="help.png" width="32px">
                        <span class="tooltiptext">
                            <h3 style="margin: 0">Parameter <code>Wifi Gateway</code></h3>
                            <p> </p>
                            <div class="admonition note">
                                <p class="admonition-title">Note</p>
                                <p>Leave emtpy if set by router.</p>
                            </div>
                            <p>The IP of your Gateway (e.g. Fritzbox).</p>
                        </span>
                    </div>
                </div>
            </td>
        </tr>
		
        <tr class="FixedIP hidden">
            <td class="indent1">Netmask</td>
            <td>
                <div id="esp32_netmask" onchange="networkParameterChanged()"> </div>
            </td>
            <td>
                <div class="rst-content">
                    <div class="tooltip">
                        <img src="help.png" width="32px">
                        <span class="tooltiptext">
                            <h3 style="margin: 0">Parameter <code>Wifi Netmask</code></h3>
                            <p> </p>
                            <div class="admonition note">
                                <p class="admonition-title">Note</p>
                                <p>Leave emtpy if set by router.</p>
                            </div>
                            <p>Define a range of IP addresses that an ISP or other organization can use. (e.g. 255.255.255.0).</p>
                        </span>
                    </div>
                </div>
            </td>
        </tr>
		
        <tr class="FixedIP hidden">
            <td class="indent1">DNS</td>
            <td>
                <div id="esp32_dns" onchange="networkParameterChanged()"> </div>
            </td>
            <td>
                <div class="rst-content">
                    <div class="tooltip">
                        <img src="help.png" width="32px">
                        <span class="tooltiptext">
                            <h3 style="margin: 0">Parameter <code>Wifi DNS</code></h3>
                            <p> </p>
                            <div class="admonition note">
                                <p class="admonition-title">Note</p>
                                <p>Leave emtpy if set by router.</p>
                            </div>
                            <p>IP Address of the used DNS server (e.g. for Google Public DNS 8.8.8.8 or 8.8.4.4).</p>
                        </span>
                    </div>
                </div>
            </td>
        </tr>

        <!------------- AuthWebUI ------------------>
        <tr>
            <td>AuthWebUI</td>
            <td>
                <select name="myAuthWebUI" id="myAuthWebUI" onchange="UpdateAfterAuthWebUICheck()">
                    <option value="false" selected>Disable</option>
                    <option value="true">Enable</option>
                </select>
            </td>
            <td class="tooltip" style="display:none;"></td>
        </tr>
		
        <tr class="AuthWebUI hidden">
            <td class="indent1">AuthWebUIUser</td>
            <td>
                <input type="text" name="myAuthWebUIUser" id="myAuthWebUIUser" onchange="networkParameterChanged()">
            </td>
            <td class="tooltip" style="display:none;"></td>
        </tr>
		
        <tr class="AuthWebUI hidden">
            <td class="indent1">AuthWebUIPw</td>
            <td>
                <input type="password" name="myAuthWebUIPw" id="myAuthWebUIPw" onchange="networkParameterChanged()">
            </td>
            <td class="tooltip" style="display:none;"></td>
        </tr>

    </table>
	
    <hr>
	
    <table style="padding-top:10px">
        <tr>
            <td>
                <input type="checkbox" id="show-pw" onclick="set_PW_Visible()">Show Password
			</td>
        </tr>
	
        <tr>
            <td>
                <button class="button" type="button" id="scan_wifi" onclick="scan_wlan_ap()">Scan Wifi AP</button>
            </td>
            <td>
                <button class="button" type="button" id="save_wifi" onclick="write_wlan_config()">Save Wifi Config</button>
            </td>
            <td>
                <button class="button" type="button" id="reboot" onclick="doReboot()">Reboot to activate changes</button>
            </td>
        </tr>
    </table>	

<script language="JavaScript">
    var ipInput = $('#esp32_ip').ipInput(),
        gatewayInput = $('#esp32_gateway').ipInput(),
        netmaskInput = $('#esp32_netmask').ipInput(),
        dnsInput = $('#esp32_dns').ipInput(),
        wifi_config_changed = false,
        fixed_ip_enable = false,
		fixed_ip_changed_ok = false,
        network_connection_type = "Wifi_STA",
        wifi_hostname = "",
        wifi_ssid = "",
        wifi_password = "",
        wifi_threshold = "0",
        wifi_ip = "",
        wifi_gateway = "",
        wifi_netmask = "",
        wifi_dns = "",
        network_connection_type_temp = "Wifi_STA",
        wifi_hostname_temp = "",
        wifi_ssid_temp = "",
        wifi_password_temp = "wifi_pw_hide",
        wifi_threshold_temp = "0",
        wifi_ip_temp = "",
        wifi_gateway_temp = "",
        wifi_netmask_temp = "",
        wifi_dns_temp = "",
        auth_web_ui_enable = false,
		auth_user = "admin",
		auth_password = "admin"
		auth_user_temp = "",
		auth_password_temp = "",
		board_type = "ESP32CAM";

    function set_ssid(ssid) {
        document.getElementById('mySSID').value = ssid.innerText || ssid.textContent;
        document.getElementById('myPassword').value = ""
        var wifi_pw = ssid.nextElementSibling.classList.contains('ssid');
        document.getElementById('myPassword').disabled = !wifi_pw;
	
        if(wifi_pw) {
            document.getElementById('myPassword').focus();
        }

		networkParameterChanged();
    };

    function networkParameterChanged() {
		if (network_connection_type != document.getElementById("myConnectionType").value) {
			network_connection_type = document.getElementById("myConnectionType").value;
			wifi_config_changed = true;
		}

		if (wifi_hostname != document.getElementById("myHostname").value) {
			wifi_hostname = document.getElementById("myHostname").value;
			wifi_config_changed = true;
		}
		
		if (wifi_ssid != document.getElementById("mySSID").value) {
			wifi_ssid = document.getElementById("mySSID").value;
			wifi_config_changed = true;
		}
		
		if (wifi_password != document.getElementById("myPassword").value) {
			wifi_password = document.getElementById("myPassword").value;
			wifi_config_changed = true;
		}
		
		if (wifi_threshold != document.getElementById("myThreshold").value) {
			wifi_threshold = document.getElementById("myThreshold").value;
			wifi_config_changed = true;
		}
		
        if (document.getElementById("myFixedIP").value == 'true') {
			if ((ipInput.getIp() != "") && (ipInput.getIp() != "undefined")) {
				wifi_ip = ipInput.getIp();
				fixed_ip_changed_ok = true;
			}
			else {
				fixed_ip_changed_ok = false;
			}

            if ((gatewayInput.getIp() != "") && (gatewayInput.getIp() != "undefined")) {
                wifi_gateway = gatewayInput.getIp();
				fixed_ip_changed_ok = true;
            }
			else {
				fixed_ip_changed_ok = false;
			}

            if ((netmaskInput.getIp() != "") && (netmaskInput.getIp() != "undefined")) {
                wifi_netmask = netmaskInput.getIp();
				fixed_ip_changed_ok = true;
            }
			else {
				fixed_ip_changed_ok = false;
			}

            if ((dnsInput.getIp() != "") && (dnsInput.getIp() != "undefined")) {
                wifi_dns = dnsInput.getIp();
				fixed_ip_changed_ok = true;
            }
			else {
				fixed_ip_changed_ok = false;
			}
        }
        else {
			wifi_ip = "";
			wifi_gateway = "";
			wifi_netmask = "";
			wifi_dns = "";
        }

		if (auth_user != document.getElementById("myAuthWebUIUser").value) {
			auth_user = document.getElementById("myAuthWebUIUser").value;
			wifi_config_changed = true;
		}
		
		if (auth_password != document.getElementById("myAuthWebUIPw").value) {
			auth_password = document.getElementById("myAuthWebUIPw").value;
			wifi_config_changed = true;
		}

        if ((wifi_config_changed == true) || (fixed_ip_changed_ok == true)) {
			document.getElementById("save_wifi").disabled = false;
		}
    }

    function write_wlan_config() {
	    document.getElementById("overlay").style.display = "block";
        document.getElementById("overlaytext").innerHTML = "Save Wifi Settings, please wait...";
	
		networkParameterChanged();
		
        if ((wifi_config_changed == true) || (fixed_ip_changed_ok == true)) {
			var url = domainname + "/editflow?task=wifi_config";
			
			if (domainname.length > 0){
				url = url + "&host=" + domainname;		
			}
			
			if (network_connection_type != network_connection_type_temp) {
				url = url + "&contype=" + network_connection_type;
			}
			if (wifi_ssid != wifi_ssid_temp) {
				url = url + "&ssid=" + wifi_ssid;
			}
			if (wifi_password != wifi_password_temp) {
				var _wifi_password = encryptDecrypt(wifi_password);
				url = url + "&password=" + encodeURI(_wifi_password);
			}
			if (wifi_hostname != wifi_hostname_temp) {
				url = url + "&hostname=" + wifi_hostname;
			}
			if (fixed_ip_enable != document.getElementById("myFixedIP").value) {
				url = url + "&fixip=" + document.getElementById("myFixedIP").value;
			}
			if (wifi_ip != wifi_ip_temp) {
				url = url + "&ip=" + wifi_ip;
			}
			if (wifi_gateway != wifi_gateway_temp) {
				url = url + "&gateway=" + wifi_gateway;
			}
			if (wifi_netmask != wifi_netmask_temp) {
				url = url + "&netmask=" + wifi_netmask;
			}
			if (wifi_dns != wifi_dns_temp) {
				url = url + "&dns=" + wifi_dns;
			}
			if (wifi_threshold != wifi_threshold_temp) {
				url = url + "&rssi=" + wifi_threshold;
			}
			if (auth_web_ui_enable != document.getElementById("myAuthWebUI").value) {
				url = url + "&auth=" + document.getElementById("myAuthWebUI").value;
			}
			if (auth_user != auth_user_temp) {
				url = url + "&authuser=" + auth_user;
			}
			if (auth_password != auth_password_temp) {
				var _auth_password = encryptDecrypt(auth_password);
				url = url + "&authpw=" + encodeURI(_auth_password);
			}

			var durchlaufe = 0;
		
			function sleep(ms) {
				return new Promise(resolve => setTimeout(resolve, ms));
			}
	
			async function task() {
				while (true) {
					var xhttp = new XMLHttpRequest();
					if (durchlaufe > 5) {
						document.getElementById("overlay").style.display = "none";
						firework.launch('Save Wifi Settings aborted, timeout!', 'warning', 5000);
						return;
					}			

					try {
						xhttp.open("GET", url, false);
						xhttp.send();				
					} catch (error){}				
            
					if (xhttp.responseText == "WifiSettingsSet") {
						wifi_config_changed = false;
						document.getElementById("reboot").disabled = false;
						document.getElementById("overlay").style.display = "none";
						firework.launch('Wifi Configuration saved. It will get applied after the next reboot!', 'success', 2000);
						return;
					}
					else {
						durchlaufe = durchlaufe + 1;
						document.getElementById("overlaytext").innerHTML = "Device is busy, plase waiting...";
						console.log("Device is busy, waiting 2s then checking again...");
						await sleep(2000);
					}
				}   
			}

			setTimeout(function() { 
				// Delay so the overlay gets shown
				task();
			}, 1);
			
			document.getElementById("save_wifi").disabled = true;
        }
        else {
			wifi_config_changed = false;
				
			document.getElementById("save_wifi").disabled = true;
			document.getElementById("reboot").disabled = true;
			
			document.getElementById("overlay").style.display = "none";
            firework.launch('Wifi Configuration not saved. No changes to the configuration were detected!', 'warning', 5000);
        }
    }

    function UpdateAfterFixedIPCheck() {
        if (document.getElementById("myFixedIP").value == 'true') {
            setVisible("FixedIP", true);
        }
        else {
            setVisible("FixedIP", false);
        }
		
		networkParameterChanged();
    }
	
    function UpdateAfterAuthWebUICheck() {
        if (document.getElementById("myAuthWebUI").value == 'true') {
            setVisible("AuthWebUI", true);
        }
        else {
            setVisible("AuthWebUI", false);
        }
		
		networkParameterChanged();
    }

    function setVisible(className, visible) {
        let elements = document.getElementsByClassName(className);
	
        for (i = 0; i < elements.length; i++) {
            if (visible) {
                elements[i].classList.remove("hidden");
            } 
            else {
                elements[i].classList.add("hidden");
            }
        }
    }

    function doReboot() {
        if (confirm("Are you sure you want to reboot?")) {
            var stringota = domainname + "/reboot";
            window.location = stringota;
            window.location.href = stringota;
            window.location.assign(stringota);
            window.location.replace(stringota);
        }
    }
	
    function set_PW_Visible() {
        if (document.getElementById("show-pw").checked) {
            document.getElementById("myPassword").type = "text";
			document.getElementById("myAuthWebUIPw").type = "text";
        } 
        else {
            document.getElementById("myPassword").type = "password";
			document.getElementById("myAuthWebUIPw").type = "password";
        }
    }
	
    function deleteAllElements(){ 
        document.getElementById('ssid').innerHTML = "";
    }	
	
    function createElement(name, rssi, auth, index){
        var quality_img = 'q-0';
        if (rssi >= -55) {
            quality_img = 'q-4';
        }
        else if (rssi < -55 && rssi >= -67) {
            quality_img = 'q-3';
        }
        else if (rssi < -67 && rssi >= -78) {
            quality_img = 'q-2';
        }
        else if (rssi < -78 && rssi >= -85) {
            quality_img = 'q-1';
        }
        else {
            quality_img = 'q-0';
        }
	
        var quality = "0";
        if(rssi <= -100) {
            quality = 0;
        }
        else if(rssi >= -50) {
            quality = 100;
        }
        else {
            quality = 2 * (100 - Math.abs(rssi));
        }
		
        var auth_temp = "";
        if (auth) {
            auth_temp = " l";
        }
	
        var div_temp = '<a href="#myPassword" id="ssid' + index + '_name_text" onclick="set_ssid(this)">' + name + '</a>\n';
        div_temp = div_temp + '<div role="img" aria-label="10%" title="10%" id="ssid' + index + '_img" class="q ' + quality_img + auth_temp + '"></div>\n';
        div_temp = div_temp + '<div id="ssid' + index + '_signal_text" class="q">' + quality + '%</div>';
		
        const container = document.getElementById('ssid');
        const newElm = document.createElement('div');
        newElm.innerHTML = div_temp;
        container.appendChild(newElm);
    }
	
    function scan_wlan_ap() {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("overlaytext").innerHTML = "Scanning for available WiFi APs, please wait...";
	
        deleteAllElements();
	
        var url = domainname + "/wifiscan";
        var durchlaufe = 0;

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function task() {
            while (true) {
                var xhttp = new XMLHttpRequest();
					
                if (durchlaufe > 5) {
                    document.getElementById("overlay").style.display = "none";
                    firework.launch('Wifi Scan timeout!', 'warning', 5000);
                    return;
                }					

                try {
                    xhttp.open("GET", url, false);
                    xhttp.send();
                } catch (error){}				
            
                if (xhttp.responseText) {
                    var wifiscanObj = JSON.parse(xhttp.responseText);
                    var wifiscanKeys = Object.keys(wifiscanObj);
                    var wifiscanValues = Object.values(wifiscanObj);
			
                    for (var i = 0; i < wifiscanKeys.length; i++) {
                        var _wifiscanKeys = Object.keys(wifiscanValues[i]);
                        var _wifiscanValues = Object.values(wifiscanValues[i]);

                        var ssid_temp = "";
                        var rssi_temp = 0;
                        var auth_temp = 0;
                        var ssid_io = 0;
						
                        for (var j = 0; j < _wifiscanKeys.length; j++) {
                            if ((_wifiscanKeys[j].toUpperCase() == "SSID") && (_wifiscanValues[j] != "")) {
                                ssid_temp = _wifiscanValues[j];
                                ssid_io = ssid_io + 1;
                            }
							
                            if ((_wifiscanKeys[j].toUpperCase() == "RSSI") && (_wifiscanValues[j] != "")) {
                                rssi_temp = _wifiscanValues[j];
                                ssid_io = ssid_io + 1;
                            }
							
                            if ((_wifiscanKeys[j].toUpperCase() == "AUTH") && (_wifiscanValues[j] != "")) {
                                if (_wifiscanValues[j] != "OPEN") {
                                    auth_temp = 1;
                                }
                                ssid_io = ssid_io + 1;
                            }
                        }
						
                        if (ssid_io >= 3) {
                            createElement(ssid_temp, rssi_temp, auth_temp, i);
                        }
                    }
					
                    document.getElementById("overlay").style.display = "none";
                    firework.launch('WiFi scan completed!', 'success', 2000);
                    return;
                }
                else {
                    // Get status
                    var _xhttp = new XMLHttpRequest();
                    durchlaufe = durchlaufe + 1;
						
                    try {
                        _xhttp.open("GET", domainname + "/statusflow", false);
                        _xhttp.send();
                    }
                    catch (error){}

                    document.getElementById("overlaytext").innerHTML = "Device is busy, plase waiting...<br><br>Current step: " + _xhttp.responseText;
                    await sleep(2000);
                }
            }
        }

        setTimeout(function() { 
            // Delay so the overlay gets shown
            task();
        }, 1);
    }

	function loadBoardType() {
		url = domainname + '/info?type=BoardType';

		fetch(url)
			.then((response) => {
			    response.text().then((data) => { 
				    board_type = data;
				    if (board_type == "ESP32-S3-ETH") {
				        const sel = document.getElementById("myConnectionType");
				        const opt = document.createElement("option");
				        opt.value = "Ethernet";
				        opt.text = "Ethernet";
				        sel.add(opt, null);
				    }
			    });
			})
			.catch((error) => console.error('Error occurred: ' + error));
	}

	function loadConnectionType() 
	{
		url = domainname + '/info?type=ConnectionType';

		fetch(url)
			.then((response) => {
			    response.text().then((data) => { 
				    network_connection_type_temp = data;
				    network_connection_type = network_connection_type_temp;
 				    document.getElementById("myConnectionType").value = network_connection_type_temp;
				    if (document.getElementById("myConnectionType").value != "Wifi_STA") {
				        document.getElementById("scan_wifi").disabled = true;
				    }
				    else {
				        document.getElementById("scan_wifi").disabled = false;
				    }
			    });
			})
			.catch((error) => console.error('Error occurred: ' + error));
	}

	function loadHostname() 
	{
		url = domainname + '/info?type=Hostname';

		fetch(url)
			.then((response) => {
			    response.text().then((data) => { 
				    wifi_hostname_temp = data;
				    wifi_hostname = wifi_hostname_temp;
 				    document.getElementById("myHostname").value = wifi_hostname_temp;
			    });
			})
			.catch((error) => console.error('Error occurred: ' + error));
	}

	function loadWifiSSID()
	{
		url = domainname + '/info?type=SSID';     

		fetch(url)
			.then((response) => {
			    response.text().then((data) => { 
				    wifi_ssid_temp = data;
 				    wifi_ssid = wifi_ssid_temp;
				    document.getElementById("mySSID").value = wifi_ssid_temp;
			    });
			})
			.catch((error) => console.error('Error occurred: ' + error));
	}
	
	function loadWifiPassword()
	{
		url = domainname + '/info?type=Password';     

		fetch(url)
			.then((response) => {
			    response.text().then((data) => { 
				    wifi_password_temp = encryptDecrypt(data);
 				    wifi_password = wifi_password_temp;
				    document.getElementById("myPassword").value = wifi_password_temp;
			    });
			})
			.catch((error) => console.error('Error occurred: ' + error));
	}

	function loadFixIPAddress() 
	{
		url = domainname + '/info?type=FixIP';     

		fetch(url)
			.then((response) => {
			    response.text().then((data) => { 
				    fixed_ip_enable = data;
				    document.getElementById("myFixedIP").value = fixed_ip_enable;
				
				    UpdateAfterFixedIPCheck();
			    });
			})
			.catch((error) => console.error('Error occurred: ' + error));
	}

	function loadIPAddress() 
	{
		url = domainname + '/info?type=IP';     

		fetch(url)
			.then((response) => {
			    response.text().then((data) => { 
				    wifi_ip_temp = data;
                    wifi_ip = wifi_ip_temp;
                    ipInput.setIp(wifi_ip_temp);
			    });
			})
			.catch((error) => console.error('Error occurred: ' + error));
	}
	
	function loadGatewayAddress() 
	{
		url = domainname + '/info?type=Gateway';     

		fetch(url)
			.then((response) => {
			    response.text().then((data) => { 
				    wifi_gateway_temp = data;
 				    wifi_gateway = wifi_gateway_temp;
                    gatewayInput.setIp(wifi_gateway_temp);
			    });
			})
			.catch((error) => console.error('Error occurred: ' + error));
	}
	
	function loadNetmaskAddress() 
	{
		url = domainname + '/info?type=Netmask';     

		fetch(url)
			.then((response) => {
			    response.text().then((data) => { 
				    wifi_netmask_temp = data;
				    wifi_netmask = wifi_netmask_temp;
                    netmaskInput.setIp(wifi_netmask_temp);
			    });
			})
			.catch((error) => console.error('Error occurred: ' + error));
	}
	
	function loadDNSAddress() 
	{
		url = domainname + '/info?type=DNS';     

		fetch(url)
			.then((response) => {
			    response.text().then((data) => { 
				    wifi_dns_temp = data;
                    wifi_dns = wifi_dns_temp;
                    dnsInput.setIp(wifi_dns_temp);
			    });
			})
			.catch((error) => console.error('Error occurred: ' + error));
	}

	function loadRSSIThreshold()
	{
		url = domainname + '/info?type=RSSI';     

		fetch(url)
			.then((response) => {
			    response.text().then((data) => { 
				    wifi_threshold_temp = data;
 				    wifi_threshold = wifi_threshold_temp;
				    document.getElementById("myThreshold").value = wifi_threshold_temp;
			    });
			})
			.catch((error) => console.error('Error occurred: ' + error));
	}

	function loadAuthWebUI() 
	{
		url = domainname + '/info?type=http_auth';     

		fetch(url)
			.then((response) => {
			    response.text().then((data) => { 
				    auth_web_ui_enable = data;
				    document.getElementById("myAuthWebUI").value = auth_web_ui_enable;
				
				    UpdateAfterAuthWebUICheck();
			    });
			})
			.catch((error) => console.error('Error occurred: ' + error));
	}
	
	function loadAuthWebUIUser() 
	{
		url = domainname + '/info?type=http_user';     

		fetch(url)
			.then((response) => {
			    response.text().then((data) => { 
				    auth_user_temp = data;
                    auth_user = auth_user_temp;
				    document.getElementById("myAuthWebUIUser").value = auth_user_temp;
			    });
			})
			.catch((error) => console.error('Error occurred: ' + error));
	}

	function loadAuthWebUIPw()
	{
		url = domainname + '/info?type=http_pw';     

		fetch(url)
			.then((response) => {
			    response.text().then((data) => { 
				    auth_password_temp = encryptDecrypt(data);
 				    auth_password = auth_password_temp;
				    document.getElementById("myAuthWebUIPw").value = auth_password_temp;
			    });
			})
			.catch((error) => console.error('Error occurred: ' + error));
	}

    function Init() {
        document.getElementById("myFixedIP").value = 'false';
        document.getElementById("myAuthWebUI").value = 'false';

        document.getElementById("scan_wifi").disabled = true;
        document.getElementById("save_wifi").disabled = true;
        document.getElementById("reboot").disabled = true;

        loadBoardType();

        loadConnectionType();
        loadHostname();
		loadWifiSSID();
		loadWifiPassword();
		loadRSSIThreshold();

		loadFixIPAddress();
		loadIPAddress();
		loadGatewayAddress();
		loadNetmaskAddress();
		loadDNSAddress();
		
		loadAuthWebUI();
		loadAuthWebUIUser();
		loadAuthWebUIPw();
	}

    Init();

    </script>
</body>
</html>